<!DOCTYPE html>
<html>
  <head>
    <title>Watson Conversation</title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript">
      var context = {}
      var i;

      function updateChat(user, message){
        if(message){
          var div = document.createElement("div");
          if(user == "Watson"){
            div.innerHTML = "<b>" + user + "</b>: <div class='alert alert-primary' role='alert'>" + message + "</div>";
          }else{
            div.innerHTML = "<b>" + user + "</b>: <div class='alert alert-secondary' role='alert'>" + message + "</div>";
          }
          document.getElementById("history").appendChild(div);
          document.getElementById("text").value = "";
          }
      }

      function sendMessage(){
        var text = document.getElementById("text").value;
        updateChat("You", text);

        var payload = {};
        var k = 1;
        if(text){ payload.input = {"text": text};};
        if(context) {payload.context = context;};
        
        var xhr = new XMLHttpRequest(); 
        xhr.onreadystatechange =  function(){
          if(xhr.readyState == 4){
            if(xhr.status == 200){
              var json = JSON.parse(xhr.responseText);
              context = json.context;
              console.log(json);
              console.log(Array.isArray(json.intents));
              if(json.matching_results == undefined || Array.isArray(json.intents)){
              updateChat("Watson", json./*matching_results*/output.text);
              i = 1;
              }else{
                if(i == 1){
                  for(var d = 0; d < json.passages.length; d++){
                  updateChat("Watson", json.passages[d].passage_text);
                  }
                }
              }
            }
          }
        }
        xhr.open("POST", "./conv", true);
        xhr.setRequestHeader("Content-type", "application/json");
        xhr.send(JSON.stringify(payload));
      }

      function init(){
        document.getElementById("text").addEventListener("keydown", function(e){
          if(!e){ var e = window.event; }
          if(e.keyCode == 13){ sendMessage();}
        }, false);
        sendMessage();
      }
    </script>

  </head>
  <body onLoad="init()">
    <div style="height: 100%; height:100%; padding:1%;" id="troll" class="rounded border border-dark">
      <button style="display:none;" id="fade"  class="btn btn-danger float-left">Clique aqui para começar a conversa!</button>
      <div  class="text-center" style="margin-bottom: 2%">
        <b style="font-size: 2em;">IBM Watson Conversation</b>
      </div>
      <div class="input-group">
          <span class="input-group-btn">
            <button class="btn btn-success" type="submit" onclick="sendMessage()">Enviar</button>
          </span>
          <input type="text" id="text" class="form-control" placeholder="Escreva sua mensagem e envie para o Watson...">
      </div>
      <p/><div class="text-center" style="font-size: 2em;"><b>Histórico da conversa</b></div>
      <p/><div id="history"></div>
    </div>
  </body>
</html>
